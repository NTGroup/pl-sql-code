
Функция Контрагенты_Check(Запрос)

  //Читаем XML из POST запроса
  
  ////<company id="1" id_c = "112123">
  ////    <name>NTGroup</name>
  ////    <contracts>
  ////        <contract id="1" id_c = "112123">
  ////            <name>001-23205</name>
  ////            <full_name>001-23205-05</full_name>
  ////        </contract>
  ////        <contract>
  ////            <name>001-232012</name>
  ////            <full_name>001-23203-Ryzh</full_name>
  ////        </contract>
  ////    </contracts>
  ////</company>  
  
  //в случае существования группы(компании), заночсим контракты в нее
  //Иначе заводим группу
  //Если контаркт существует, обновляем его данные
  //Иначе создаем новый контракт
  //
  
  v_XML=""; 
  //читаем XML
  XML = Новый ЧтениеXML;
  XML.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
  
  
  XML.Прочитать();
  Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
    v_XML=v_XML + "<" + XML.Имя + ">";
    
    //company
    if XML.Имя = "company" then    // мы находимся на <company>      
      XML.Прочитать(); // мы находимся на <name>
      Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
        v_XML=v_XML + "<" + XML.Имя + ">";
        if XML.Имя = "name" then            
          XML.Прочитать(); // мы находимся внутри name можем прочитать name value
          if XML.ТипУзла = ТипУзлаXML.Текст then
            v_XML=v_XML + """" +XML.Значение+""""; 
            Группа = Справочники.Контрагенты.НайтиПоНаименованию(XML.Значение,Истина);
            
            Если Группа.Пустая() Тогда 
                Группа = Справочники.Контрагенты.СоздатьГруппу(); 
                Группа.Наименование = XML.Значение;
                Группа.Записать();
            //ИначеЕсли Не Группа.ЭтоГруппа Тогда 
            //    Сообщить("Найден элемент справочника с указанным кодом!");   
            //    // Предусмотреть прерывание алгоритма.
            КонецЕсли;            
            
            XML.Прочитать(); // мы находимся на </name>
          endif;
        endif;
      КонецЕсли;
    endif;
  КонецЕсли;
  
  //contracts
  XML.Прочитать(); // мы находимся на <contracts>
  if XML.Имя = "contracts" then    // мы находимся на <contracts>
    Пока XML.Прочитать() Цикл
    
      Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
        v_XML=v_XML + "<" + XML.Имя + ">";
        if XML.Имя = "contract" then            
          
          XML.Прочитать(); // мы находимся на <name>
          Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
            v_XML=v_XML + "<" + XML.Имя + ">";
            if XML.Имя = "name" then            
              XML.Прочитать(); // мы находимся можем прочитать name
              if XML.ТипУзла = ТипУзлаXML.Текст then
                
                link_contr = Справочники.Контрагенты.НайтиПоНаименованию(XML.Значение,Истина);
                
                Если link_contr.Пустая() Тогда 
                  v_cntr = Справочники.Контрагенты.СоздатьЭлемент(); 
                Иначе
                  v_cntr = link_contr.ПолучитьОбъект();
                КонецЕсли;
                
                v_cntr.Наименование = XML.Значение;
                v_XML=v_XML + """" +XML.Значение+""""; 
                XML.Прочитать(); // мы находимся на </name>
              endif;
            endif;
          КонецЕсли;
          
          XML.Прочитать(); // мы находимся на <full_name>
          Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
            v_XML=v_XML + "<" + XML.Имя + ">";
            if XML.Имя = "full_name" then            
              XML.Прочитать(); // мы находимся можем прочитать name
              if XML.ТипУзла = ТипУзлаXML.Текст then
                v_XML=v_XML + """" +XML.Значение+""""; 
                v_cntr.НаименованиеПолное = XML.Значение;
                v_cntr.Родитель = Группа.Ссылка;  
                XML.Прочитать(); // мы находимся на </name>
              endif;
            endif;
          КонецЕсли;
          v_cntr.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо;
          v_cntr.Записать();  
          ПолныйКодКонтрагента = v_cntr.ПолныйКод();
          v_XML=v_XML + "код=" + ПолныйКодКонтрагента; 
          
        endif;
      КонецЕсли;
    КонецЦикла;
  endif;
  
  XML.Закрыть();  

  // в ответ отдаем код 200 и что-нибудь в теле ответа
  //ПолныйКодКонтрагента = v_cntr.ПолныйКод();
  Ответ = Новый HTTPСервисОтвет(200);
  Ответ.УстановитьТелоИзСтроки("Контрагенты_Check Работает" + v_XML);
  Возврат Ответ;
КонецФункции

Функция Счета_Check(Запрос)
  
  //посик группы по имени. пусть имя будет "Бла-Бла и КО"
  ИмяГруппы = "Бла-Бла и КО"; 
  Группа = Справочники.Контрагенты.НайтиПоНаименованию(ИмяГруппы,Истина);
  //создаем пустой элементо. заполняем его данными и сохраняем.
  v_cntr = Справочники.Контрагенты.СоздатьЭлемент(); 

  v_XML=""; 
  //читаем XML
  XML = Новый ЧтениеXML;
  XML.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());

XML = Новый ЧтениеXML;
XML.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
Пока XML.Прочитать() Цикл
  
  Если XML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
v_XML=v_XML + "<" + XML.Имя + ">";
      //company
      if XML.Имя = "company" then
        //Пока XML.ПрочитатьАтрибут() Цикл
        // v_XML=v_XML + XML.Имя + " = " + XML.Значение;
        //КонецЦикла;
        XML.Прочитать();
        Если XML.ТипУзла = ТипУзлаXML.Текст Тогда
          v_cntr.Наименование = XML.Значение;
          v_XML=v_XML + """" +XML.Значение+""""; 
        КонецЕсли;
      endif;

  Пока XML.ПрочитатьАтрибут() Цикл
   v_XML=v_XML + XML.Имя + " = " + XML.Значение;
 КонецЦикла;
 
КонецЕсли;

  Если XML.ТипУзла = ТипУзлаXML.Текст Тогда
  v_XML=v_XML + """" +XML.Значение+"""";
  КонецЕсли;
  Если XML.ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
   v_XML=v_XML + "END";
  КонецЕсли;
КонецЦикла;
XML.Закрыть();


  v_cntr.НаименованиеПолное = "Рыжиков Павел Евгеньевич";
  v_cntr.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо;
  v_cntr.Родитель = Группа.Ссылка;  
  v_cntr.Записать();  
  // в ответ отдаем код 200 и что-нибудь в теле ответа
  ПолныйКодКонтрагента = v_cntr.ПолныйКод();
  Ответ = Новый HTTPСервисОтвет(200);
  Ответ.УстановитьТелоИзСтроки("Контрагенты_Check Работает "+ПолныйКодКонтрагента  + v_XML );
  Возврат Ответ;

КонецФункции
